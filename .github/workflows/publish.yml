name: Publish # this workflow is setup to be self-contained

on:
  release:
    types:
      - published

jobs:
  publish:
    name:  Build > Bundle > Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup
        uses: actions/setup-node@v3
        with:
          node-version: 18.x
          registry-url: https://registry.npmjs.org
          cache: npm

      - name: Install
        run: |
          npm install typescript dts-bundle-generator @types/node c8 \
            eslint eslint-config-prettier eslint-plugin-markdown \
            eslint-plugin-prettier eslint-plugin-yaml@1.0.3 prettier \
            prettier-plugin-properties @stedi/prettier-plugin-jsonata \
          && npm clean-install \

      - name: Build
        run: |
          npx tsc --minify

      - name: Bundle
        run: |
          npx dts-bundle-generator --config=./.github/linters/dts.config.js \

      - name: Release
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          npm publish --access public \
